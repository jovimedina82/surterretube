##
## /etc/nginx/sites-available/surterretube.conf
##

# Redirect HTTP -> HTTPS
server {
    listen 80;
    server_name surterretube.com www.surterretube.com;
    return 301 https://$host$request_uri;
}

# HTTPS
server {
    client_max_body_size 10g;     # or whatever you want as a hard cap
    client_body_timeout 3600s;
    listen 443 ssl http2;
    server_name surterretube.com www.surterretube.com;
    # /etc/nginx/sites-available/surterretube.conf  (inside the TLS server block)

    send_timeout 600s;                  # writing to client
    proxy_read_timeout 600s;            # upstream -> nginx
    proxy_send_timeout 600s;            # nginx -> upstream
    proxy_http_version 1.1;
    proxy_request_buffering off;        # stream straight to Node instead of buffering
    proxy_set_header Connection "";     # keep HTTP/1.1 streaming happy

    # --- TLS ---
    ssl_certificate     /etc/letsencrypt/live/surterretube.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/surterretube.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384";

    # --- Security headers ---
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin" always;

    # --- Web UI (Next.js on :3000) ---
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host              $host;
        proxy_request_buffering off;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade           $http_upgrade;
        proxy_set_header Connection        "upgrade";
        proxy_cache_bypass                 $http_upgrade;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # --- Chat WebSocket (Node on :3001) ---
    location /ws {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade           $http_upgrade;
        proxy_set_header Connection        "upgrade";
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header Authorization "Bearer $arg_token";
        proxy_read_timeout  86400s;
        proxy_send_timeout  86400s;
        proxy_buffering off;
    }

    # --- HLS from DISK (primary) ---
    # /hls/ -> /mnt/media/hls/ via alias
    location ^~ /hls/ {
        alias /mnt/media/hls/;

        # MIME types
        types {
            application/vnd.apple.mpegurl m3u8;
            video/mp2t ts;
        }

        # LL-HLS/cache/CORS friendly
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Expose-Headers "Content-Length" always;
        # inside the HTTPS server { ... }
        

        # If file briefly missing, fall back to SRS HTTP server
        try_files $uri @srs_fallback;

        # Preflight (optional)
        if ($request_method = OPTIONS) {
            add_header 'Access-Control-Allow-Origin'  '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Range' always;
            add_header 'Access-Control-Max-Age'       1728000 always;
            add_header 'Content-Type'                 'text/plain; charset=UTF-8' always;
            add_header 'Content-Length'               0 always;
            return 204;
        }
    }

    # --- Fallback to SRS (:8080) only when disk file not found ---
    location @srs_fallback {
        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # --- Node REST API passthroughs (on :3001) ---
    location /status      { 
        # proxy_pass http://127.0.0.1:3001/status;
        proxy_set_header Host $host;
        proxy_pass http://127.0.0.1:3001/status$is_args$args;
    }
    location /chat/       {
         proxy_pass http://127.0.0.1:3001/chat/; 
    }
    location /srs/hls_notify { 
        proxy_pass http://127.0.0.1:3001/srs/hls_notify; 
    }

    # --- Health check (served by Nginx itself) ---
    location /healthz {
        access_log off;
        return 200 "OK";
    }
    location /stats { 
        proxy_pass http://127.0.0.1:3001/stats; 
    }
    location /reactions {
    proxy_pass http://127.0.0.1:3001/reactions;
    }


    location = /api/admin/authz {
        proxy_pass http://127.0.0.1:3000/api/admin/authz;
        proxy_set_header Host $host;
    }
    # --- VOD from DISK (public, for uploaded videos) ---
# /vod/ -> /mnt/media/vod/ via alias
location ^~ /vod/ {
    alias /mnt/media/vod/;
    #auth_request /api/admin/authz;
    types {
        image/jpeg  jpg jpeg;
        image/png   png;
        image/webp  webp;
        video/mp4   mp4;
    }
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header Access-Control-Allow-Origin "*" always;
    try_files $uri =404;
}

    # --- Presence heartbeat (viewer pings while playing) ---
    location /presence/ {
        proxy_pass http://127.0.0.1:3001/presence/;
        proxy_http_version 1.1;
        proxy_set_header Host            $host;
        proxy_set_header X-Real-IP       $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # --- Large admin uploads ---
    location = /api/admin/videos {
        client_max_body_size 8g;
        client_body_timeout 3600s;
        proxy_request_buffering off;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Cookie $http_cookie;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie            $http_cookie;
        proxy_pass http://127.0.0.1:3000;
    }

}




